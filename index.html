<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pitch Maintenance Evaluation â€“ v4</title>
<style>
  :root{
    --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --line:#e5e7eb; --pill:#f3f4f6;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box;}
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--fg); margin:0; padding:24px;}
  h1{font-size:22px;margin:0 0 6px;}
  h2{font-size:18px;margin:20px 0 10px;}
  .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;}
  .right{display:flex; align-items:center; gap:8px;}
  .lang-toggle{display:flex; gap:8px; align-items:center;}
  .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:var(--pill); color:#111827; font-size:12px;}
  button, select, input, textarea{font:inherit;}
  .tabbar{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 16px;}
  .tabbar button{padding:8px 12px; border:1px solid var(--line); background:#fff; border-radius:10px; cursor:pointer;}
  .tabbar button.active{background:var(--fg); color:#fff; border-color:var(--fg);}
  .card{border:1px solid var(--line); border-radius:14px; padding:16px; background:#fff;}
  .grid{display:grid; gap:12px;}
  @media(min-width:1100px){ .grid-2{grid-template-columns:1fr 1fr;} }
  label{display:block; font-weight:600; margin:8px 0 6px;}
  select, input[type="text"], textarea{width:100%; padding:10px; border:1px solid var(--line); border-radius:10px;}
  .range-row{display:grid; grid-template-columns:minmax(180px, 380px) 1fr 56px 120px; align-items:center; gap:10px; margin:6px 0;}
  input[type="range"]{width:100%;}
  .muted{color:#6b7280; font-size:12px;}
  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
  .primary{background:var(--fg); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;}
  .outline{background:#fff; color:#111827; border:1px solid var(--line); padding:10px 14px; border-radius:10px; cursor:pointer;}
  .table{width:100%; border-collapse:collapse; margin-top:10px; font-size:14px;}
  .table th, .table td{border-bottom:1px solid var(--line); padding:8px; text-align:left; vertical-align:middle;}
  canvas{max-width:100%;}
  .disclaimer{background:#f9fafb; border:1px dashed var(--line); border-radius:10px; padding:10px; font-size:12px; color:#374151;}

  /* Inline gradient bar (1â€“5 scale) */
  .bar{display:inline-block; width:140px; height:10px; background:#e5e7eb; border-radius:8px; margin-left:8px; position:relative; top:2px; vertical-align:middle; overflow:hidden;}
  .bar > i{position:absolute; left:0; top:0; bottom:0; width:0%; border-radius:8px; display:block;}

  .admin-btn{border:1px solid var(--line); background:#fff; border-radius:999px; padding:8px 12px; cursor:pointer;}
  .lock{font-size:12px; color:#6b7280;}

  @media print{
    body{padding:0;}
    .tabbar, .lang-toggle, #btnExport, #btnCSV, #btnReset, #btnPDF, #adminBtn, #findingsBox, #btnHardReset{display:none !important;}
    .card{border:none; padding:0;}
  }
</style>
</head>
<body>
  <div class="top">
    <div>
      <h1 data-i="title">Pitch Maintenance Evaluation</h1>
      <div class="muted" data-i="subtitle">Structured scoring â€¢ Year-round scope â€¢ Weighted summary â€¢ QR access</div>
    </div>
    <div class="right">
      <div class="lang-toggle">
        <span class="pill">EN / AR</span>
        <select id="langSel">
          <option value="en">English</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        </select>
      </div>
      <button id="adminBtn" class="admin-btn"><span data-i="admin">Admin</span> <span class="lock">ğŸ”’</span></button>
    </div>
  </div>

  <div class="tabbar">
    <button class="active" data-tab="survey" id="tabSurvey">Survey</button>
    <button data-tab="summary" id="tabSummary" style="display:none;">Summary</button>
    <button data-tab="notes" id="tabNotes" style="display:none;">Notes</button>
    <button data-tab="method" id="tabMethod" style="display:none;">Methodology</button>
    <button data-tab="qr" id="tabQR" style="display:none;">QR</button>
  </div>

  <!-- SURVEY -->
  <section class="card grid" id="survey">
    <div class="disclaimer" id="scopeNote"></div>
    <div class="grid grid-2">
      <div>
        <label data-i="role">Your role</label>
        <select id="role">
          <option value="football_director">Football Director</option>
          <option value="head_coach">Head Coach</option>
          <option value="technical_staff">Technical Staff</option>
          <option value="player">Player</option>
          <option value="medical">Medical Team</option>
          <option value="administrative">Administrative Team</option>
        </select>
      </div>
      <div>
        <label data-i="name">Your name (optional)</label>
        <input id="name" type="text" placeholder="">
      </div>
    </div>

    <h2 data-i="secA">A. Pitch Quality</h2>
    <div id="secA" class="grid"></div>

    <h2 data-i="secB">B. Maintenance Effectiveness</h2>
    <div id="secB" class="grid"></div>

    <h2 data-i="secC">C. Overall</h2>
    <div id="secC" class="grid"></div>

    <label data-i="comments">General notes (optional)</label>
    <textarea id="comments" rows="3"></textarea>

    <div class="actions">
      <button class="primary" id="btnSubmit" data-i="submit">Submit response</button>
      <button class="outline" id="btnClear" data-i="clear">Clear form</button>
    </div>
    <div class="muted" id="saveNote"></div>
  </section>

  <!-- SUMMARY (Protected) -->
  <section class="card" id="summary" style="display:none;">
    <div class="grid grid-2">
      <div>
        <h2 data-i="resOverview">Results Overview</h2>
        <div id="counts" class="muted"></div>
        <table class="table" id="avgTable">
          <thead>
            <tr><th data-i="cat">Category</th><th data-i="avg">Average (1â€“5)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:10px;">
          <div class="pill" data-i="overall">Overall Weighted Score:</div>
          <div id="overallScore" class="pill">â€“</div>
        </div>
        <div class="actions">
          <button class="outline" id="btnCSV">Export CSV</button>
          <button class="outline" id="btnExport" data-i="export">Export JSON</button>
          <button class="outline" id="btnPDF">Download PDF (Summary)</button>
          <button class="outline" id="btnReset" data-i="reset">Reset responses</button>
          <button class="outline" id="btnHardReset">Full Reset (everything)</button>
        </div>
      </div>
      <div>
        <h2 data-i="chart">Summary Chart</h2>
        <canvas id="barChart" width="520" height="280"></canvas>
      </div>
    </div>

    <h2 data-i="kfTitle">Key Findings & Recommendation</h2>
    <div id="findingsBox" class="card" style="padding:12px; border:1px dashed var(--line);">
      <div id="findingsText" class="muted">â€“</div>
      <div class="actions" style="margin-top:8px;">
        <button class="outline" id="btnCopyFindings">Copy findings</button>
      </div>
    </div>

    <h2 data-i="weights">Weights (by role)</h2>
    <div class="grid grid-2">
      <div class="range-row"><div>Head Coach</div><input type="range" min="0" max="100" value="20" id="w_hc"><div id="w_hc_v">20</div></div>
      <div class="range-row"><div>Football Director</div><input type="range" min="0" max="100" value="20" id="w_fd"><div id="w_fd_v">20</div></div>
      <div class="range-row"><div>Technical Staff</div><input type="range" min="0" max="100" value="20" id="w_ts"><div id="w_ts_v">20</div></div>
      <div class="range-row"><div>Players</div><input type="range" min="0" max="100" value="20" id="w_pl"><div id="w_pl_v">20</div></div>
      <div class="range-row"><div>Medical Team</div><input type="range" min="0" max="100" value="10" id="w_md"><div id="w_md_v">10</div></div>
      <div class="range-row"><div>Administrative Team</div><input type="range" min="0" max="100" value="10" id="w_ad"><div id="w_ad_v">10</div></div>
    </div>
    <div class="muted" data-i="weightsNote">Weights auto-normalize to 100% when calculating the overall score.</div>

    <h2 data-i="participation">Participation</h2>
    <div id="partCounts" class="muted"></div>
    <canvas id="partChart" width="900" height="260" style="margin-top:10px;"></canvas>

    <h2 data-i="responses">Responses</h2>
    <table class="table" id="respTable">
      <thead><tr>
        <th data-i="thTime">Time</th>
        <th data-i="thRole">Role</th>
        <th data-i="thA">A</th>
        <th data-i="thB">B</th>
        <th data-i="thC">C</th>
        <th data-i="thOverall">Overall</th>
        <th data-i="thNote">Note</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- NOTES (Protected) -->
  <section class="card" id="notes" style="display:none;">
    <h2 data-i="notesTitle">All Notes</h2>
    <table class="table">
      <thead><tr>
        <th data-i="thTime">Time</th>
        <th data-i="thRole">Role</th>
        <th data-i="thName">Name</th>
        <th data-i="thNote">Note</th>
      </tr></thead>
      <tbody id="notesBody"></tbody>
    </table>
  </section>

  <!-- METHODOLOGY (Protected) -->
  <section class="card" id="method" style="display:none;">
    <h2 data-i="methTitle">Methodology</h2>
    <p data-i="methText">
      Participants: Football Director, Head Coach, Technical Staff, Players, Medical Team, and Administrative Team.
      Scope: This evaluation covers the entire year (not only the current pitch status). It is designed to support continuous improvements and an objective view of the current situation.
      Scoring: 1 (Poor) to 5 (Excellent). All questions are visible to all roles; each item includes an "N/A â€“ Not relevant to me" toggle which excludes it from the averages.
      Averages are computed per category (over answered items only) and overall. Weighted overall score applies role weights (editable) and normalizes to 100%.
    </p>
  </section>

  <!-- QR (Protected) -->
  <section class="card" id="qr" style="display:none;">
    <h2 data-i="qrTitle">QR Access</h2>
    <label data-i="qrLabel">Target URL (leave as current if hosted):</label>
    <input id="qrURL" placeholder="https://your-domain.com/pitch-eval.html">
    <div class="actions">
      <button class="primary" id="btnQR" data-i="genQR">Generate QR</button>
      <button class="outline" id="btnQRSave" data-i="saveQR">Download QR PNG</button>
    </div>
    <canvas id="qrCanvas" width="240" height="240" style="border:1px solid #e5e7eb; border-radius:8px;"></canvas>
  </section>

<script>
/* ======================== Admin Lock ======================== */
const PASSWORD = "7373";
function isUnlocked(){ return sessionStorage.getItem('admin_unlocked') === '1'; }
function unlock(){ sessionStorage.setItem('admin_unlocked','1'); showProtectedTabs(true); }
function showProtectedTabs(show){
  ['tabSummary','tabMethod','tabQR','tabNotes'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = show ? 'inline-block' : 'none';
  });
  if(!show){ showTab('survey'); }
}
document.getElementById('adminBtn').addEventListener('click', ()=>{
  const lang = localStorage.getItem('lang') || 'en';
  const msg = (lang==='ar') ? 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:' : 'Enter password:';
  const pw = prompt(msg);
  if(pw === PASSWORD){ unlock(); document.getElementById('adminBtn').innerHTML = (lang==='ar'?'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©':'Admin') + ' âœ…'; }
  else if(pw !== null){ alert((lang==='ar')?'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©':'Incorrect password'); }
});
document.addEventListener('click', (e)=>{
  const t = e.target;
  if(t.matches('.tabbar button') && ['summary','method','qr','notes'].includes(t.dataset.tab)){
    if(!isUnlocked()){
      e.preventDefault(); e.stopPropagation();
      alert((localStorage.getItem('lang')||'en')==='ar'?'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©':'Please unlock via the Admin button.');
    }
  }
});
showProtectedTabs(isUnlocked());

/* ======================== i18n ======================== */
const I = {
  en:{title:"Pitch Maintenance Evaluation", subtitle:"Structured scoring â€¢ Year-round scope â€¢ Weighted summary â€¢ QR access",
      role:"Your role", name:"Your name (optional)",
      secA:"A. Pitch Quality", secB:"B. Maintenance Effectiveness", secC:"C. Overall",
      comments:"General notes (optional)", submit:"Submit response", clear:"Clear form",
      resOverview:"Results Overview", cat:"Category", avg:"Average (1â€“5)",
      overall:"Overall Weighted Score:", chart:"Summary Chart", weights:"Weights (by role)",
      weightsNote:"Weights auto-normalize to 100% when calculating the overall score.",
      participation:"Participation", total:"Total", responses:"Responses",
      thTime:"Time", thRole:"Role", thA:"A", thB:"B", thC:"C", thOverall:"Overall", thName:"Name", thNote:"Note",
      export:"Export JSON", reset:"Reset responses", methTitle:"Methodology",
      methText:"Participants: Football Director, Head Coach, Technical Staff, Players, Medical, Administrative. Scope: year-round evaluation (not only the current pitch). Scoring: 1â€“5 with 'N/A' to exclude items from averages. Weighted summary by role.",
      qrTitle:"QR Access", qrLabel:"Target URL (leave as current if hosted):", genQR:"Generate QR", saveQR:"Download QR PNG",
      admin:"Admin", notesTitle:"All Notes",
      // Questions
      A1:"Grass condition and density", A2:"Surface evenness & ball movement", A3:"Grip & safety during play", A4:"Drainage during rain", A5:"Visual/professional appearance",
      B1:"Speed of response to requests", B2:"Quality of weekly maintenance", B3:"Communication & follow-up", B4:"Professionalism of team", B5:"Consistency over time",
      C1:"Overall satisfaction", C2:"Improvement vs last seasons", C3:"Readiness for matches/training", C4:"Recommend renewal?",
      scopeEN:"Scope: Evaluate performance across the entire year (not only the current status), to support continuous improvements and an objective view of the current situation.",
      NA:"N/A",
      kfTitle:"Key Findings & Recommendation",
      kf_overall_ex:"Overall evaluation is excellent.",
      kf_overall_good:"Overall evaluation is good.",
      kf_overall_avg:"Overall evaluation is average; improvements needed.",
      kf_overall_poor:"Overall evaluation is below expectations; major intervention required.",
      kf_cat_low:"Lowest category: ",
      kf_role_gap:"Role gap observed: ",
      kf_reco_ex:"Maintain standards and continue current plan.",
      kf_reco_good:"Address minor issues in the lowest category to reach excellence.",
      kf_reco_avg:"Prioritize improvements in the lowest category within the next cycle.",
      kf_reco_poor:"Launch an urgent improvement plan with clear KPIs and timelines.",
      copyFindings:"Copy findings"
  },
  ar:{title:"ØªÙ‚ÙŠÙŠÙ… ØµÙŠØ§Ù†Ø© Ø£Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ù„Ø¹Ø¨", subtitle:"ØªÙ‚ÙŠÙŠÙ… Ù…ÙÙ†Ø¸Ù… â€¢ Ù†Ø·Ø§Ù‚ Ø³Ù†ÙˆÙŠ â€¢ Ù…Ù„Ø®Øµ Ù…ÙØ±Ø¬Ù‘Ø­ â€¢ ÙˆØµÙˆÙ„ Ø¹Ø¨Ø± QR",
      role:"Ø§Ù„Ø¯ÙˆØ±/Ø§Ù„ØµÙØ©", name:"Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
      secA:"Ø£. Ø¬ÙˆØ¯Ø© Ø£Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ù„Ø¹Ø¨", secB:"Ø¨. ÙƒÙØ§Ø¡Ø© Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©", secC:"Ø¬. Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…",
      comments:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", submit:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…", clear:"Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬",
      resOverview:"Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬", cat:"Ø§Ù„ÙØ¦Ø©", avg:"Ø§Ù„Ù…ØªÙˆØ³Ø· (1â€“5)",
      overall:"Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ÙØ±Ø¬Ù‘Ø­:", chart:"Ù…Ø®Ø·Ø· Ù…ÙˆØ¬Ø²", weights:"Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±",
      weightsNote:"ØªÙØ·Ø¨Ù‘Ø¹ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø¥Ù„Ù‰ 100% Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨.", participation:"Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©", total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", responses:"Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª",
      thTime:"Ø§Ù„ÙˆÙ‚Øª", thRole:"Ø§Ù„ØµÙØ©", thA:"Ø£", thB:"Ø¨", thC:"Ø¬", thOverall:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ", thName:"Ø§Ù„Ø§Ø³Ù…", thNote:"Ù…Ù„Ø§Ø­Ø¸Ø©",
      export:"ØªØµØ¯ÙŠØ± JSON", reset:"Ù…Ø³Ø­ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª", methTitle:"Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠØ©",
      methText:"Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†: Ù…Ø¯ÙŠØ± Ø§Ù„ÙƒØ±Ø©ØŒ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙÙ†ÙŠØŒ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ÙÙ†ÙŠØŒ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†ØŒ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø·Ø¨ÙŠØŒ ÙˆØ§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ. Ø§Ù„Ù†Ø·Ø§Ù‚: ØªÙ‚ÙŠÙŠÙ… Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø¹Ø§Ù… (ÙˆÙ„ÙŠØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·). Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ù† 1 Ø¥Ù„Ù‰ 5 Ù…Ø¹ Ø®ÙŠØ§Ø± 'ØºÙŠØ± Ø°ÙŠ ØµÙ„Ø©' Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·. Ù…Ù„Ø®Øµ Ù…ÙØ±Ø¬Ù‘Ø­ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±.",
      qrTitle:"Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (QR)", qrLabel:"Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:", genQR:"ØªÙˆÙ„ÙŠØ¯ QR", saveQR:"Ø­ÙØ¸ QR ÙƒØµÙˆØ±Ø©",
      admin:"Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", notesTitle:"Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
      A1:"Ø­Ø§Ù„Ø© ÙˆÙƒØ«Ø§ÙØ© Ø§Ù„Ø¹Ø´Ø¨", A2:"Ø§Ø³ØªÙˆØ§Ø¡ Ø§Ù„Ø³Ø·Ø­ ÙˆØ­Ø±ÙƒØ© Ø§Ù„ÙƒØ±Ø©", A3:"Ø§Ù„Ø«Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨", A4:"ØªØµØ±ÙŠÙ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø£Ù…Ø·Ø§Ø±", A5:"Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©",
      B1:"Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª", B2:"Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©", B3:"Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©", B4:"Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙØ±ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø©", B5:"Ø«Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„ÙˆÙ‚Øª",
      C1:"Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ø¹Ø§Ù…", C2:"Ø§Ù„ØªØ­Ø³Ù† Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ù…ÙˆØ§Ø³Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©", C3:"Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù„Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª", C4:"Ø§Ù„ØªÙˆØµÙŠØ© Ø¨Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ØŸ",
      scopeEN:"Ø§Ù„Ù†Ø·Ø§Ù‚: ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø¹Ø§Ù… (ÙˆÙ„ÙŠØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·)ØŒ Ø¨Ù‡Ø¯Ù Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø± ÙˆØªÙƒÙˆÙŠÙ† Ø±Ø¤ÙŠØ© Ù…ÙˆØ¶ÙˆØ¹ÙŠØ© Ø¹Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ.",
      NA:"ØºÙŠØ± Ø°ÙŠ ØµÙ„Ø©",
      kfTitle:"Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„ØªÙˆØµÙŠØ©",
      kf_overall_ex:"Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù… Ù…Ù…ØªØ§Ø².",
      kf_overall_good:"Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù… Ø¬ÙŠØ¯.",
      kf_overall_avg:"Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù… Ù…ØªÙˆØ³Ø·Ø› Ù‡Ù†Ø§Ùƒ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†.",
      kf_overall_poor:"Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù… Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø› ÙŠÙ„Ø²Ù… ØªØ¯Ø®Ù„ ÙƒØ¨ÙŠØ±.",
      kf_cat_low:"Ø£Ù‚Ù„ ÙØ¦Ø©: ",
      kf_role_gap:"ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø±: ",
      kf_reco_ex:"Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
      kf_reco_good:"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø£Ù‚Ù„ ÙØ¦Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ…ÙŠØ².",
      kf_reco_avg:"Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙˆÙ„ÙˆÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø£Ù‚Ù„ ÙØ¦Ø© ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.",
      kf_reco_poor:"Ø¥Ø·Ù„Ø§Ù‚ Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø¹Ø§Ø¬Ù„Ø© Ù…Ø¹ Ù…Ø¤Ø´Ø±Ø§Øª Ø£Ø¯Ø§Ø¡ ÙˆØ¬Ø¯Ø§ÙˆÙ„ Ø²Ù…Ù†ÙŠØ©.",
      copyFindings:"Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬Ø§Øª"
  }
};

const ALL_A = ["A1","A2","A3","A4","A5"];
const ALL_B = ["B1","B2","B3","B4","B5"];
const ALL_C = ["C1","C2","C3","C4"];

function makeSliderRow(key, labelText, lang){
  const row = document.createElement('div'); row.className='range-row';
  row.innerHTML = `
    <div>${labelText}</div>
    <input type="range" min="1" max="5" step="1" value="3" data-k="${key}" data-na="0">
    <div>3</div>
    <label class="muted"><input type="checkbox" data-na-toggle="${key}"> ${I[lang].NA}</label>
  `;
  const slider = row.querySelector('input[type="range"]');
  slider.addEventListener('input', e => { row.children[2].textContent = e.target.value; });
  const naToggle = row.querySelector(`input[data-na-toggle="${key}"]`);
  naToggle.addEventListener('change', e => {
    const na = e.target.checked;
    slider.disabled = na; slider.setAttribute('data-na', na ? '1':'0');
    row.children[2].textContent = na ? 'â€”' : slider.value;
  });
  return row;
}

function buildSections(){
  ['secA','secB','secC'].forEach(id => document.getElementById(id).innerHTML='');
  const lang = localStorage.getItem('lang') || 'en';
  ALL_A.forEach(k => document.getElementById('secA').appendChild(makeSliderRow(k, I[lang][k]||k, lang)));
  ALL_B.forEach(k => document.getElementById('secB').appendChild(makeSliderRow(k, I[lang][k]||k, lang)));
  ALL_C.forEach(k => document.getElementById('secC').appendChild(makeSliderRow(k, I[lang][k]||k, lang)));
}

function applyLang(){
  const sel = document.getElementById('langSel'); const lang = sel.value;
  document.documentElement.dir = (lang==='ar') ? 'rtl' : 'ltr';
  for (const el of document.querySelectorAll('[data-i]')){
    const k = el.getAttribute('data-i'); if (I[lang][k]) el.textContent = I[lang][k];
  }
  document.getElementById('name').placeholder = (lang==='ar'?'Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯':'e.g., Ahmed');
  document.getElementById('scopeNote').textContent = I[lang].scopeEN;
  buildSections();
  if(isUnlocked()){ document.getElementById('adminBtn').innerHTML = (lang==='ar'?'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©':'Admin') + ' âœ…'; }
}
document.getElementById('langSel').addEventListener('change', ()=>{
  localStorage.setItem('lang', document.getElementById('langSel').value); applyLang();
});
(function initLang(){ const saved = localStorage.getItem('lang') || 'en'; document.getElementById('langSel').value = saved; applyLang(); })();

/* ======================== Data helpers ======================== */
function getAvgFor(keys){
  let sum=0, count=0;
  keys.forEach(k=>{
    const slider = document.querySelector(`input[data-k="${k}"]`);
    if(slider && slider.getAttribute('data-na')!=='1'){
      sum += parseInt(slider.value,10); count += 1;
    }
  });
  if(count===0) return 0;
  return sum / count;
}
function nowISO(){ const d=new Date(); return d.toISOString().replace('T',' ').slice(0,19); }
function loadAll(){ try{ return JSON.parse(localStorage.getItem('pitch_eval_data')||'[]'); }catch(e){ return []; } }
function saveAll(arr){ localStorage.setItem('pitch_eval_data', JSON.stringify(arr)); }

/* ======================== Submit / Clear ======================== */
document.getElementById('btnSubmit').addEventListener('click', ()=>{
  const role = document.getElementById('role').value;
  const name = document.getElementById('name').value.trim();
  const A = getAvgFor(ALL_A);
  const B = getAvgFor(ALL_B);
  const C = getAvgFor(ALL_C);
  const overall = (A+B+C)/3;
  const comments = document.getElementById('comments').value.trim();
  const rec = {time: nowISO(), role, name, A, B, C, overall, comments};
  const data = loadAll(); data.push(rec); saveAll(data);
  const isAR = (localStorage.getItem('lang')||'en')==='ar';
  document.getElementById('saveNote').textContent = isAR?'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©.':'Response saved.';
  setTimeout(()=>{ document.getElementById('saveNote').textContent=''; }, 1600);
  // reset form
  for(const inp of document.querySelectorAll('input[type="range"]')){ inp.value=3; inp.setAttribute('data-na','0'); inp.disabled=false; inp.dispatchEvent(new Event('input')); }
  for(const ck of document.querySelectorAll('input[type="checkbox"][data-na-toggle]')){ ck.checked=false; }
  document.getElementById('comments').value=''; if(name) document.getElementById('name').value='';
});

document.getElementById('btnClear').addEventListener('click', ()=>{
  for(const inp of document.querySelectorAll('input[type="range"]')){ inp.value=3; inp.setAttribute('data-na','0'); inp.disabled=false; inp.dispatchEvent(new Event('input')); }
  for(const ck of document.querySelectorAll('input[type="checkbox"][data-na-toggle]')){ ck.checked=false; }
  document.getElementById('comments').value='';
});

/* ======================== Labels ======================== */
function roleLabel(v, lang){
  const map = {
    football_director: (lang==='ar'?'Ù…Ø¯ÙŠØ± Ø§Ù„ÙƒØ±Ø©':'Football Director'),
    head_coach: (lang==='ar'?'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙÙ†ÙŠ':'Head Coach'),
    technical_staff: (lang==='ar'?'Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ÙÙ†ÙŠ':'Technical Staff'),
    player: (lang==='ar'?'Ù„Ø§Ø¹Ø¨':'Player'),
    medical: (lang==='ar'?'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø·Ø¨ÙŠ':'Medical Team'),
    administrative: (lang==='ar'?'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ':'Administrative Team')
  };
  return map[v] || v;
}

/* ======================== Gradient color (1â€“5) ======================== */
function lerp(a,b,t){ return a + (b-a)*t; }
function rgb(r,g,b){ return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`; }
/* red(239,68,68) â†’ yellow(245,158,11) â†’ green(16,185,129) */
function colorScale(v){
  v = Math.max(1, Math.min(5, v||0));
  if(v <= 3){
    const t = (v-1)/2;
    return rgb( lerp(239,245,t), lerp(68,158,t), lerp(68,11,t) );
  } else {
    const t = (v-3)/2;
    return rgb( lerp(245,16,t), lerp(158,185,t), lerp(11,129,t) );
  }
}
function makeBarCell(value){
  const td = document.createElement('td');
  const val = document.createElement('span');
  val.textContent = value ? value.toFixed(2) : 'â€“';
  const bar = document.createElement('span'); bar.className='bar';
  const fill = document.createElement('i');
  const pct = value ? Math.max(0, Math.min(100, (value/5)*100)) : 0;
  fill.style.width = pct + '%';
  fill.style.background = colorScale(value||0);
  bar.appendChild(fill);
  td.appendChild(val); td.appendChild(bar);
  return td;
}

/* ======================== Summary Render ======================== */
function renderSummary(){
  const lang = localStorage.getItem('lang') || 'en';
  const data = loadAll();
  const roles = ["football_director","head_coach","technical_staff","player","medical","administrative"];
  const counts = {}; roles.forEach(r=>counts[r]=0); data.forEach(r=> counts[r.role]=(counts[r.role]||0)+1 );

  // Participation text line
  const total = data.length;
  const partText = `${I[lang].total}: ${total} â€¢ ` + roles.map(r => `${roleLabel(r,lang)}: ${counts[r]||0}`).join(' â€¢ ');
  document.getElementById('counts').textContent = partText;

  // Averages
  const avg = (k)=> data.length? (data.reduce((s,r)=>s+r[k],0)/data.length):0;
  const avgA = avg('A'), avgB = avg('B'), avgC = avg('C');
  const tbody = document.querySelector('#avgTable tbody'); tbody.innerHTML='';
  const rows = [
    {key:'A', label:(lang==='ar'?'Ø£. Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ù„Ø¹Ø¨':'A. Pitch Quality'), val:avgA},
    {key:'B', label:(lang==='ar'?'Ø¨. ÙƒÙØ§Ø¡Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©':'B. Maintenance Effectiveness'), val:avgB},
    {key:'C', label:(lang==='ar'?'Ø¬. Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…':'C. Overall'), val:avgC},
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const tdLabel = document.createElement('td'); tdLabel.textContent = r.label;
    tr.appendChild(tdLabel);
    tr.appendChild(makeBarCell(r.val));
    tbody.appendChild(tr);
  });

  // Weights + overall weighted (verified)
  const w = {
    head_coach: parseInt(document.getElementById('w_hc').value,10),
    football_director: parseInt(document.getElementById('w_fd').value,10),
    technical_staff: parseInt(document.getElementById('w_ts').value,10),
    player: parseInt(document.getElementById('w_pl').value,10),
    medical: parseInt(document.getElementById('w_md').value,10),
    administrative: parseInt(document.getElementById('w_ad').value,10)
  };
  const sumW = Object.values(w).reduce((a,b)=>a+b,0) || 1;
  function avgRole(role){
    const rs = data.filter(r=>r.role===role);
    return rs.length? (rs.reduce((s,r)=>s+r.overall,0)/rs.length):0;
  }
  let weighted = 0;
  Object.keys(w).forEach(role=>{ const av = avgRole(role); weighted += av * w[role]; });
  weighted = weighted / sumW;
  document.getElementById('overallScore').textContent = data.length? weighted.toFixed(2):'â€“';

  // responses table
  const tb = document.querySelector('#respTable tbody'); tb.innerHTML='';
  data.slice().reverse().forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.time}</td><td>${roleLabel(r.role,lang)}</td>
                    <td>${r.A.toFixed(2)}</td><td>${r.B.toFixed(2)}</td><td>${r.C.toFixed(2)}</td>
                    <td>${r.overall.toFixed(2)}</td><td>${(r.comments||'').replace(/\n/g,' ')}</td>`;
    tb.appendChild(tr);
  });

  // --- Key Findings & Recommendation ---
  (function(){
    const L = I[lang];
    const cats = [{k:'A',v:avgA},{k:'B',v:avgB},{k:'C',v:avgC}].sort((a,b)=>a.v-b.v);
    const lowest = cats[0];
    let overallMsg, reco;
    const ow = weighted || 0;
    if (ow >= 4.5){ overallMsg = L.kf_overall_ex; reco = L.kf_reco_ex; }
    else if (ow >= 3.5){ overallMsg = L.kf_overall_good; reco = L.kf_reco_good; }
    else if (ow >= 2.5){ overallMsg = L.kf_overall_avg; reco = L.kf_reco_avg; }
    else { overallMsg = L.kf_overall_poor; reco = L.kf_reco_poor; }
    const roleKeys = ['head_coach','football_director','technical_staff','player','medical','administrative'];
    const roleAvgs = roleKeys.map(rk => ({rk, v: avgRole(rk) || 0}));
    const minRole = roleAvgs.reduce((m,x)=> x.v<m.v?x:m, roleAvgs[0]||{rk:'',v:0});
    const maxRole = roleAvgs.reduce((m,x)=> x.v>m.v?x:m, roleAvgs[0]||{rk:'',v:0});
    let gapTxt = '';
    if ((maxRole.v - minRole.v) >= 0.5){
      const rname = (r)=>roleLabel(r, lang);
      gapTxt = L.kf_role_gap + rname(minRole.rk) + ' (' + (minRole.v?minRole.v.toFixed(2):'â€“') + ') vs ' + rname(maxRole.rk) + ' (' + (maxRole.v?maxRole.v.toFixed(2):'â€“') + ').';
    }
    const catName = lowest.k==='A' ? (lang==='ar'?'Ø£. Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ù„Ø¹Ø¨':'A. Pitch Quality')
                   : lowest.k==='B' ? (lang==='ar'?'Ø¨. ÙƒÙØ§Ø¡Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©':'B. Maintenance Effectiveness')
                   : (lang==='ar'?'Ø¬. Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…':'C. Overall');
    const msg = [
      overallMsg,
      L.kf_cat_low + catName + ' (' + (lowest.v?lowest.v.toFixed(2):'â€“') + ').',
      gapTxt,
      reco
    ].filter(Boolean).join(' ');
    const box = document.getElementById('findingsText');
    if (box) box.textContent = msg || 'â€“';
  })();

  // charts
  drawBarChart('barChart', [avgA, avgB, avgC, weighted],
    [(lang==='ar'?'Ø£':'A'), (lang==='ar'?'Ø¨':'B'), (lang==='ar'?'Ø¬':'C'), (lang==='ar'?'Ø§Ù„Ø¹Ø§Ù…':'Overall')], 5);

  // participation chart
  const partLabels = roles.map(r=>roleLabel(r,lang));
  const partVals = roles.map(r=>counts[r]||0);
  const maxPart = Math.max(5, ...partVals);
  document.getElementById('partCounts').textContent = partText;
  drawBarChart('partChart', partVals, partLabels, maxPart);
}

/* ======================== Notes Render ======================== */
function renderNotes(){
  const lang = localStorage.getItem('lang') || 'en';
  const data = loadAll();
  const body = document.getElementById('notesBody'); body.innerHTML='';
  data.filter(r => (r.comments||'').trim().length>0)
      .slice().reverse()
      .forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.time}</td><td>${roleLabel(r.role,lang)}</td><td>${r.name||''}</td><td>${(r.comments||'').replace(/\n/g,' ')}</td>`;
        body.appendChild(tr);
      });
}

/* ======================== Weight listeners ======================== */
['w_hc','w_fd','w_ts','w_pl','w_md','w_ad'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{ 
    document.getElementById(id+'_v').textContent = document.getElementById(id).value; 
    renderSummary();
  });
});

/* ======================== Export / Reset / Copy ======================== */
document.getElementById('btnReset').addEventListener('click', ()=>{
  if(confirm('Reset all stored responses?')){ localStorage.removeItem('pitch_eval_data'); renderSummary(); renderNotes(); }
});

// Full reset
document.getElementById('btnHardReset').addEventListener('click', ()=>{
  if(!confirm('This will erase ALL responses, restore default weights, reset language, and lock admin. Continue?')) return;
  localStorage.removeItem('pitch_eval_data');
  // default weights
  const def = {w_hc:20,w_fd:20,w_ts:20,w_pl:20,w_md:10,w_ad:10};
  Object.keys(def).forEach(k=>{ document.getElementById(k).value = def[k]; document.getElementById(k+'_v').textContent = String(def[k]); });
  // language
  localStorage.setItem('lang','en'); document.getElementById('langSel').value='en'; applyLang();
  // lock admin
  sessionStorage.removeItem('admin_unlocked');
  document.getElementById('adminBtn').innerHTML = 'Admin <span class="lock">ğŸ”’</span>';
  showProtectedTabs(false);
  renderSummary(); renderNotes();
  alert('Reset complete. Youâ€™re back to a clean start.');
});

// Export JSON
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob = new Blob([localStorage.getItem('pitch_eval_data')||'[]'], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pitch_evaluation_responses.json'; a.click();
});
// Export CSV
document.getElementById('btnCSV').addEventListener('click', ()=>{
  const rows = JSON.parse(localStorage.getItem('pitch_eval_data')||'[]');
  const header = ['time','role','name','A','B','C','overall','comments'];
  const csv = [header.join(',')].concat(rows.map(r => header.map(h => {
    const v = (r[h]!==undefined && r[h]!==null) ? String(r[h]) : '';
    return '"' + v.replace(/"/g,'""') + '"';
  }).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='pitch_evaluation_responses.csv'; a.click();
});
// PDF (print summary)
document.getElementById('btnPDF').addEventListener('click', ()=>{ renderSummary(); window.print(); });
// Copy findings
(function(){
  const btn = document.getElementById('btnCopyFindings');
  if(btn){
    btn.textContent = (localStorage.getItem('lang')||'en')==='ar' ? I.ar.copyFindings : I.en.copyFindings;
    btn.addEventListener('click', async ()=>{
      const txt = document.getElementById('findingsText')?.textContent || '';
      try{ await navigator.clipboard.writeText(txt); btn.textContent = ((localStorage.getItem('lang')||'en')==='ar')?'ØªÙ… Ø§Ù„Ù†Ø³Ø®':'Copied!'; }
      catch(e){
        const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        btn.textContent = ((localStorage.getItem('lang')||'en')==='ar')?'ØªÙ… Ø§Ù„Ù†Ø³Ø®':'Copied!';
      }
      setTimeout(()=>{ btn.textContent = ((localStorage.getItem('lang')||'en')==='ar') ? I.ar.copyFindings : I.en.copyFindings; }, 1200);
    });
  }
})();

/* ======================== Simple bar chart ======================== */
function drawBarChart(id, vals, labels, maxVal){
  const c = document.getElementById(id), ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const pad=30, W=c.width, H=c.height;
  const max = Math.max(1, maxVal || 5);
  const bw = (W - pad*2) / vals.length * 0.6;
  const gap = (W - pad*2) / vals.length * 0.4;
  ctx.strokeStyle='#e5e7eb'; ctx.beginPath(); ctx.moveTo(pad, H - pad); ctx.lineTo(W - pad, H - pad); ctx.stroke();
  vals.forEach((v,i)=>{
    const x = pad + i*(bw+gap);
    const h = (H - pad*2) * ((v||0)/max);
    const y = H - pad - h;
    ctx.fillStyle = '#111827'; ctx.fillRect(x, y, bw, h);
    ctx.fillStyle = '#6b7280'; ctx.textAlign='center';
    ctx.fillText(labels[i], x+bw/2, H - pad + 16);
    ctx.fillText((v!==undefined && v!==null) ? String(v.toFixed ? v.toFixed(2) : v) : 'â€“', x+bw/2, y - 4);
  });
}

/* ======================== QR (placeholder generator) ======================== */
function drawFakeQR(text, size){
  const c = document.getElementById('qrCanvas'), ctx=c.getContext('2d');
  ctx.clearRect(0,0,size,size);
  let h=0; for(let i=0;i<text.length;i++) h=(h*31 + text.charCodeAt(i))>>>0;
  const cells=29, cell=Math.floor(size/cells);
  for(let r=0;r<cells;r++){
    for(let col=0;col<cells;col++){
      const v=((h + r*97 + col*131) % 11) > 5;
      ctx.fillStyle = v ? '#000':'#fff';
      ctx.fillRect(col*cell, r*cell, cell, cell);
    }
  }
  ctx.strokeStyle='#e5e7eb'; ctx.strokeRect(0,0,size,size);
}
document.getElementById('btnQR').addEventListener('click', ()=>{
  const url = document.getElementById('qrURL').value.trim() || location.href;
  drawFakeQR(url, 240);
});
document.getElementById('btnQRSave').addEventListener('click', ()=>{
  const c = document.getElementById('qrCanvas');
  const a = document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='pitch_eval_qr.png'; a.click();
});

/* ======================== Tabs ======================== */
function showTab(id){
  if(['summary','method','qr','notes'].includes(id) && !isUnlocked()){
    alert((localStorage.getItem('lang')||'en')==='ar'?'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©':'Please unlock via the Admin button.');
    return;
  }
  for (const sec of ['survey','summary','notes','method','qr']){
    const el = document.getElementById(sec);
    if(el) el.style.display = (sec===id)?'block':'none';
    const btn = document.getElementById('tab'+sec.charAt(0).toUpperCase()+sec.slice(1));
    if(btn) btn.classList.toggle('active', sec===id);
  }
  if(id==='summary'){ renderSummary(); }
  if(id==='notes'){ renderNotes(); }
}
document.querySelectorAll('.tabbar button').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));

/* ======================== Init ======================== */
function init(){
  buildSections();
  showProtectedTabs(isUnlocked());
}
init();
</script>
</body>
</html>
